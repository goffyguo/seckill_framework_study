## 动静分离

把用户请求的数据（如HTML页面）划分为“动态数据”和“静态数据”。

简单来说，“动态数据”和“静态数据”的主要区别就是看页面中输出的数据是否和URL、浏览者、时间、地域相关，以及是否含有Cookie等私密数据。比如说：

1. 很多媒体类的网站，某一篇文章的内容不论是你访问还是我访问，他都是一样的。这就是一个典型的静态数据，但是他是一个动态页面。
2. 访问淘宝的首页，每一个的首页看到的商品应该都是不一样的，淘宝根据每个人的购物习惯以及浏览历史推荐的商品会展示在每一个人的首页。而这个个性化的数据就可以理解为动态数据了。

也就是说，我们所说的静态数据，不能仅仅理解为传统意义上完全存在磁盘的HTML页面，它可能是经过Java系统产生的页面，但是它输出的页面本身不包含上面所说的那些因素。也就是所谓“动态”还是“静态”，并不是说数据本身是否动静，而是数据中是否含有和访问者相关的个人化数据。

理解了动态数据和静态数据，就明白为什么要做“动静分离”。对分离出来的静态数据做缓存，有了缓存之后，静态数据的“访问效率”自然就提高了。

### 静态数据做缓存

1. 把静态数据缓存到离用户最近的地方
2. 直接缓存HTTP连接
3. 谁来缓存缓存静态数据

### 动静分离的改造

### 动静分离的架构方案

### 总结

总结：

抽象总结：

动静分离的思想暗含着：分而治之和重点把控变化的思维

分而治之：几乎所有不能直接解决的问题，都会分割开来，直到比较容易解决为止，学习也类似，把不能理解的知识做分割，直到比较容易理解。

把控变化：管理或者研究事物发展的趋势，就需要重点关注和把控变化的情况，静态的容易处理，所以，变化的就对整体起到了决定性的作用。

## 热点数据隔离

假设你的系统中存储有几十亿上百亿的商品，而每天有千万级的商品被上亿的用户访问，那么肯定有一部分被大量用户访问的热卖商品，这就是我们常说的“热点商品”。

这些热点商品中最极端的例子就是秒杀商品，他们在很短的时间内被大量用户执行访问、添加购物车、下单等操作，这些操作就称为“热点操作”。

### 为什么关注热点？

因为热点会对系统产生一系列的影响。首先，热点请求会大量占用服务器处理资源，虽然这个热点可能只占请求总量的亿分之一，然后却可能抢占90%的服务器资源，如果这个热点请求还是没有价值的无效请求，那么对系统资源来说完全是浪费。其次，即使是有效的请求，也需要识别出来做针对性的优化，从而用更低的代价来支撑这些热点请求。

### 什么是热点？

热点分为“热点操作”和“热点数据”。

所谓“热点操作”，例如大量的刷新新页面、大量的添加购物车、双十一零点大量的下单等都属于此类操作。对系统来说，这些操作可以抽象为“读请求”和“写请求”，他们的处理方式也大相径庭，读请求的优化空间要大一些，而写请求的瓶颈一般都在存储层，优化的思路就是根据CAP理论理论进行取舍。

而“热点数据”就比较好理解了，就是用户的热点请求对应的数据。而热点数据又分为“静态热点数据”和“动态热点数据”。

所谓“静态热点数据”，就是能够提前预测的热点数据。例如，我们可以通过卖家报名的方式提前筛选出来，通过报名系统对这些热点商品进行打标。另外，我们还可以通过大数据分析来提前发现热点商品，比如我们分析历史成交记录、用户的购物车记录，来发现哪些商品可能更热门、更好卖，这些都是可以提前分析出来的热点。

所谓“动态热点数据”，就是不能被提前预测到的，系统在运行过程中临时产生的热点。例如，卖家在抖音上做了广告，然后商品一下就火了，导致它在短时间内被大量购买。

由于热点操作是用户的行为，我们不好改变，但能做一些限制和保护，所以本文我主要针对热点数据来介绍如何进行优化。

### 热点数据的优化

#### 发现热点数据

#### 处理热点数据

处理热点数据通常有几种思路：优化、限制、隔离

##### 优化

优化热点数据最有效的办法就是缓存热点数据，如果热点数据做了动静分 离，那么可以长期缓存静态数据。但是，缓存热点数据更多的是“临时”缓存，即不管是静 态数据还是动态数据，都用一个队列短暂地缓存数秒钟，由于队列长度有限，可以采用 LRU 淘汰算法替换。

##### 限制

限制更多的是一种保护机制，限制的办法也有很多，例如对被访问商品的 ID 做一致性 Hash，然后根据 Hash 做分桶，每个分桶设置一个处理队列，这样可以把热 点商品限制在一个请求队列里，防止因某些热点商品占用太多的服务器资源，而使其他请求 始终得不到服务器的处理资源。

##### 隔离

秒杀系统设计的第一个原则就是将这种热点数据隔离出来，不要让 1% 的请求影响到另外的 99%，隔离出来后也更方便对这 1% 的请求做针对性的优化。

具体对应到秒杀业务

- **业务隔离**。把秒杀做成一种营销活动，卖家要参加秒杀这种营销活动需要单独报名，从 技术上来说，卖家报名后对我们来说就有了已知热点，因此可以提前做好预热。
- **系统隔离**。系统隔离更多的是运行时的隔离，可以通过分组部署的方式和另外 99% 分 开。秒杀可以申请单独的域名，目的也是让请求落到不同的集群中。
-  **数据隔离**。秒杀所调用的数据大部分都是热点数据，比如会启用单独的 Cache 集群或者 MySQL 数据库来放热点数据，目的也是不想 0.01% 的数据有机会影响 99.99% 数据。

当然了，实现隔离有很多种办法。比如，你可以按照用户来区分，给不同的用户分配不同的 Cookie，在接入层，路由到不同的服务接口中;再比如，你还可以在接入层针对 URL 中的 不同 Path 来设置限流策略。服务层调用不同的服务接口，以及数据层通过给数据打标来区 分等等这些措施，其目的都是把已经识别出来的热点请求和普通的请求区分开。

### 总结

## 流量削峰

对于秒杀系统来说，最终抢到商品的人数是固定的，也就是说100人和1000人发起请求的结果是一样的，并发度越高，无效请求也越多。但是从业务上来说，秒杀活动是希望更多的人来参与的，也就是开始之前希望更多的人参与进来刷新页面，但是真正开始下单时，秒杀请求并不是越多越好。

因此，就需要设计一些规则，让并发的请求更多的延缓，而且甚至 可以过滤掉一些无效请求。

### 为什么要削峰

服务器的处理资源是恒定的，你用或者不用它的处理能力都是一样的，所以出现峰值的话，很容易导致忙到处理不过来，闲的时候却又没有什么要处理。但是由于要保证服务质量，我们的很多处理资源只能按照忙的时候来预估，而这会导致资源的一个浪费。

这就好比因为存在早高峰和晚高峰的问题，所以有了错峰限行的解决方案。削峰的存在，一是可以让服务端处理变得更加平稳，二是可以节省服务器的资源成本。针对秒杀这一场景，削峰从本质上来说就是更多地延缓用户请求的发出，以便减少和过滤掉一些无效请求，它遵从“请求数要尽量少”的原则。

流量削峰的一些操作思路：排队、答题、分层过滤。这几种方式都是无损(即不会损失用户的发出请求)的实现方案，当然还有些有损的实现方案，包括后面要介绍的关于稳定性的一些办法，比如限流和机器负载保护等一些强制措施也能达到削峰保护的目的，当然这都是不得已的一些措施，因此就不归类到这里了。

### 排队

### 答题

### 分层过滤

### 总结

## 性能优化

## 减库存设计的核心逻辑

一个问题：用户下单了就算这个商品卖出去了，还是等到用户真正付款了才算卖出去了呢？

根据减库存是发生在下单阶段还是付款阶段，把减库存做一下划分：

### 减库存的几种方式

在正常的电商平台购物场景中，用户的实际购买过程一般分为两步:下单和付款。你想买一 台 iPhone 手机，在商品页面点了“立即购买”按钮，核对信息之后点击“提交订单”，这 一步称为下单操作。下单之后，你只有真正完成付款操作才能算真正购买，也就是俗话说 的“落袋为安”。

- **下单减库存**

  当买家下单后，在商品的总库存中减去买家购买数量。下单减库存是最简 单的减库存方式，也是控制最精确的一种，下单时直接通过数据库的事务机制控制商品库 存，这样一定不会出现超卖的情况。但是你要知道，有些人下完单可能并不会付款。

- **付款减库存**

  买家下单后，并不立即减库存，而是等到有用户付款后才真正减库存，否 则库存一直保留给其他买家。但因为付款时才减库存，如果并发比较高，有可能出现买家 下单后付不了款的情况，因为可能商品已经被其他人买走了

- **预扣库存**

  这种方式相对复杂一些，买家下单后，库存为其保留一定的时间(如 10 分 钟)，超过这个时间，库存将会自动释放，释放后其他买家就可以继续购买。在买家付款 前，系统会校验该订单的库存是否还有保留:如果没有保留，则再次尝试预扣;如果库存 不足(也就是预扣失败)则不允许继续付款;如果预扣成功，则完成付款并实际地减去库存。

这几种方式都会存在问题：

### 下单减库存

即用户下单后就减去库存，正常情况下，买家下单后付款的概率会很高，所以不会有太大问题。但是有一种场景例外，就是当卖家参加某个活动时，此时活动的有效时间是商品的黄金售卖时间，如果有竞争对手通过恶意下单的方式将该卖家的商品全部下单，让这款商品的库存减为零，那么这款商品就不能正常售卖了。要知道，这些恶意下单的人是不会真正付款的，这正是“下单减库存”方式的不足之处。

### 付款减库存

超卖：假如有 100 件商品，就可能出现 300 人下单成功的情况，因为下单时不会减库存，所以也 就可能出现下单成功数远远超过真正库存数的情况，这尤其会发生在做活动的热门商品上。 这样一来，就会导致很多买家下单成功但是付不了款，买家的购物体验自然比较差。

可以看到，不管是“下单减库存”还是“付款减库存”，都会导致商品库存不能完全和实际售卖情况对应起来的情况，看来要把商品准确地卖出去还真是不容易啊!

### 预扣库存

这种方案确实可以在一定程度上缓解上面的问题。但是否就彻底解决了呢?其实没有!针对 恶意下单这种情况，虽然把有效的付款时间设置为 10 分钟，但是恶意买家完全可以在 10 分钟后再次下单，或者采用一次下单很多件的方式把库存减完。针对这种情况，解决办法还 是要结合安全和反作弊的措施来制止。

例如，给经常下单不付款的买家进行识别打标(可以在被打标的买家下单时不减库存)、给 某些类目设置最大购买件数(例如，参加活动的商品一人最多只能买 3 件)，以及对重复 下单不付款的操作进行次数限制等。

针对“库存超卖”这种情况，在 10 分钟时间内下单的数量仍然有可能超过库存数量，遇到 这种情况我们只能区别对待:对普通的商品下单数量超过库存数量的情况，可以通过补货来 解决;但是有些卖家完全不允许库存为负数的情况，那只能在买家付款时提示库存不足。

### 秒杀系统中如何减库存

目前来看，业务系统中最常见的就是预扣库存方案，像你在买机票、买电影票时，下单后一般都有个“有效付款时间”，超过这个时间订单自动释放，这都是典型的预扣库存方案。而具体到秒杀这个场景，应该采用哪种方案比较好呢？

由于参加秒杀的商品，一般都是“抢到就是赚到”，所以成功下单后却不付款的情况比较少，再加上卖家对秒杀商品的库存有严格限制，所以秒杀商品采用“下单减库存”更加合理。另外，理论上由于“下单减库存”比“预扣库存”以及涉及第三方支付的“付款减库存”在逻辑上更为简单，所以性能上更占优势。

## 兜底方案